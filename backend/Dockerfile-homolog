ARG SPRING_DATASOURCE_URL
ARG SPRING_DATASOURCE_USERNAME
ARG SPRING_DATASOURCE_PASSWORD
ARG APP_FILES_REPOSITORY_FULL_PATH
ARG SPRING_RABBITMQ_PASSWORD
ARG SPRING_RABBITMQ_USERNAME
ARG SPRING_RABBITMQ_HOST
ARG SPRING_ELASTICSEARCH_HOST
ARG SPRING_ELASTICSEARCH_USER
ARG SPRING_ELASTICSEARCH_PASSWORD

FROM adoptopenjdk/openjdk11:jdk-11.0.11_9-alpine as build
ARG SPRING_DATASOURCE_URL
ARG SPRING_DATASOURCE_USERNAME
ARG SPRING_DATASOURCE_PASSWORD
ARG APP_FILES_REPOSITORY_FULL_PATH
ARG SPRING_RABBITMQ_PASSWORD
ARG SPRING_RABBITMQ_USERNAME
ARG SPRING_RABBITMQ_HOST
ARG SPRING_ELASTICSEARCH_HOST
ARG SPRING_ELASTICSEARCH_USER
ARG SPRING_ELASTICSEARCH_PASSWORD

WORKDIR /app

COPY mvnw .
COPY .mvn .mvn
COPY pom.xml .
COPY src src
COPY openssl.cnf /etc/ssl/openssl.cnf
RUN dos2unix mvnw
RUN ./mvnw clean install package -DskipTests
RUN mkdir -p target/dependency
RUN cd target/dependency; jar -xf ../*.jar

FROM adoptopenjdk/openjdk11:jre-11.0.11_9-alpine
ARG SPRING_DATASOURCE_URL
ARG SPRING_DATASOURCE_USERNAME
ARG SPRING_DATASOURCE_PASSWORD
ARG APP_FILES_REPOSITORY_FULL_PATH
ARG SPRING_RABBITMQ_PASSWORD
ARG SPRING_RABBITMQ_USERNAME
ARG SPRING_RABBITMQ_HOST
ARG SPRING_ELASTICSEARCH_HOST
ARG SPRING_ELASTICSEARCH_USER
ARG SPRING_ELASTICSEARCH_PASSWORD

ENV SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
ENV SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
ENV SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
ENV APP_FILES_REPOSITORY_FULL_PATH=${APP_FILES_REPOSITORY_FULL_PATH}
ENV SPRING_RABBITMQ_PASSWORD=${SPRING_RABBITMQ_PASSWORD}
ENV SPRING_RABBITMQ_USERNAME=${SPRING_RABBITMQ_USERNAME}
ENV SPRING_RABBITMQ_HOST=${SPRING_RABBITMQ_HOST}
ENV SPRING_ELASTICSEARCH_HOST=${SPRING_ELASTICSEARCH_HOST}
ENV SPRING_ELASTICSEARCH_USER=${SPRING_ELASTICSEARCH_USER}
ENV SPRING_ELASTICSEARCH_PASSWORD=${SPRING_ELASTICSEARCH_PASSWORD}

RUN mkdir -p ${APP_FILES_REPOSITORY_FULL_PATH}

RUN apk add --no-cache tzdata

ENV TZ=America/Recife
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

ARG DEPENDENCY=/app/target/dependency

COPY --from=build ${DEPENDENCY}/BOOT-INF/lib /app/lib
COPY --from=build ${DEPENDENCY}/META-INF /app/META-INF
COPY --from=build ${DEPENDENCY}/BOOT-INF/classes /app


ENTRYPOINT ["java", "-cp","app:app/lib/*", "-Dspring.profiles.active=homolog", "br.gov.ac.tce.licon.Application"]
